// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  HOST
  PLAYER
  MODERATOR
  VIEWER
}

enum StreamStatus {
  WAITING
  LIVE
  PAUSE
  FINISHED
}

enum MessageType {
  TEXT
  SYSTEM
  REACTION
}

enum PointType {
  TRIVIA
  GAME
  DONATION
  BONUS
}

enum TransactionType {
  PURCHASE
  EARN
  SPEND
  TRANSFER
}

enum NotificationType {
  SYSTEM
  GAME_INVITE
  REWARD
}

// Models

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  role      UserRole @default(VIEWER)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  hostedStreams     Stream[]          @relation("HostStreams")
  hostedGames       Game[]            @relation("HostGames")
  moderatedGames    Game[]            @relation("ModeratorGames")
  participatedGames GameParticipant[]
  points            UserPoints[]
  transactions      Transaction[]
  messages          ChatMessage[]
  notifications     Notification[]

  // Self-relation for Followers
  followedBy User[] @relation("UserFollows")
  following  User[] @relation("UserFollows")

  @@map("users")
}

model Stream {
  id        String       @id @default(uuid())
  title     String
  hostId    String       @map("host_id")
  host      User         @relation("HostStreams", fields: [hostId], references: [id])
  startTime DateTime?    @map("start_time")
  endTime   DateTime?    @map("end_time")
  status    StreamStatus @default(WAITING)

  // Relations
  games     Game[]
  questions Question[]

  @@map("streams")
}

model Game {
  id          String   @id @default(uuid())
  title       String
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Foreign Keys
  hostId      String @map("host_id")
  host        User   @relation("HostGames", fields: [hostId], references: [id])
  moderatorId String? @map("moderator_id")
  moderator   User?   @relation("ModeratorGames", fields: [moderatorId], references: [id])
  streamId    String @map("stream_id")
  stream      Stream @relation(fields: [streamId], references: [id])

  // Relations
  participants GameParticipant[]
  messages     ChatMessage[]

  @@map("games")
}

model Question {
  id           String   @id @default(uuid())
  questionText String   @map("question_text")
  options      Json     
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  streamId String @map("stream_id")
  stream   Stream @relation(fields: [streamId], references: [id])

  @@map("questions")
}

model GameParticipant {
  id       String   @id @default(uuid())
  role     UserRole
  score    Int      @default(0)
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  gameId String @map("game_id")
  game   Game   @relation(fields: [gameId], references: [id])
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  @@map("game_participants")
}

model UserPoints {
  id        String    @id @default(uuid())
  amount    Int
  pointType PointType @map("point_type")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  @@map("user_points")
}

model Transaction {
  id          String          @id @default(uuid())
  type        TransactionType
  amount      Int
  description String?
  createdAt   DateTime        @default(now()) @map("created_at")

  // Relations
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  @@map("transactions")
}

model ChatMessage {
  id          String      @id @default(uuid())
  messageText String      @map("message_text")
  messageType MessageType @map("message_type") @default(TEXT)
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relations
  gameId   String @map("game_id")
  game     Game   @relation(fields: [gameId], references: [id])
  senderId String @map("sender_id")
  sender   User   @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

model Notification {
  id        String           @id @default(uuid())
  type      NotificationType
  content   String
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  @@map("notifications")
}
